(function(){Backbone.InfiniScroll=function(e,t){function f(e){var t={};return t[n.options.param]=typeof e[n.options.untilAttr]=="function"?e[n.options.untilAttr]():e.get(n.options.untilAttr),t[n.options.pageSizeParam]=n.options.pageSize,n.options.includePage&&(t.page=s+1),t}t=t||{};var n={},r,i,s,o,u=0;o=e.length||25,n.collection=e,n.options=_.defaults(t,{success:function(){},error:function(){},onFetch:function(){},target:$(window),param:"until",extraParams:{},pageSizeParam:"page_size",untilAttr:"id",pageSize:o,scrollOffset:100,remove:!1,strict:!1,includePage:!1});var a=function(){r=$(n.options.target),i=!0,s=1,r.on("scroll",n.watchScroll)};return n.destroy=function(){r.off("scroll",n.watchScroll)},n.enableFetch=function(){i=!0},n.disableFetch=function(){i=!1},n.onFetch=function(){n.options.onFetch()},n.fetchSuccess=function(e,t){n.options.strict&&e.length>=(s+1)*n.options.pageSize||!n.options.strict&&t.length>0?(n.enableFetch(),s+=1):n.disableFetch(),n.options.success(e,t)},n.fetchError=function(e,t){n.enableFetch(),n.options.error(e,t)},n.watchScroll=function(e){var t,s=r.scrollTop()+r.height(),o=r.get(0).scrollHeight;o||(o=$(document).height());if(s>=o-n.options.scrollOffset&&i&&u<=s){var a=n.collection.last();if(!a)return;n.onFetch(),n.disableFetch(),n.collection.fetch({success:n.fetchSuccess,error:n.fetchError,remove:n.options.remove,data:$.extend(f(a),n.options.extraParams)})}u=s},a(),n}})();