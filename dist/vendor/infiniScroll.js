(function(){Backbone.InfiniScroll=function(e,t){function n(e){var t={};return t[r.options.param]=typeof e[r.options.untilAttr]=="function"?e[r.options.untilAttr]():e.get(r.options.untilAttr),t[r.options.pageSizeParam]=r.options.pageSize,r.options.includePage&&(t.page=o+1),t}t=t||{};var r={},i,s,o,u,a=0;u=e.length||25,r.collection=e,r.options=_.defaults(t,{success:function(){},error:function(){},onFetch:function(){},target:$(window),param:"until",extraParams:{},pageSizeParam:"page_size",untilAttr:"id",pageSize:u,scrollOffset:100,remove:!1,strict:!1,includePage:!1});var f=function(){i=$(r.options.target),s=!0,o=1,i.on("scroll",r.watchScroll)};return r.destroy=function(){i.off("scroll",r.watchScroll)},r.enableFetch=function(){s=!0},r.disableFetch=function(){s=!1},r.onFetch=function(){r.options.onFetch()},r.fetchSuccess=function(e,t){r.options.strict&&e.length>=(o+1)*r.options.pageSize||!r.options.strict&&t.length>0?(r.enableFetch(),o+=1):r.disableFetch(),r.options.success(e,t)},r.fetchError=function(e,t){r.enableFetch(),r.options.error(e,t)},r.watchScroll=function(e){var t,o=i.scrollTop()+i.height(),u=i.get(0).scrollHeight;u||(u=$(document).height());if(o>=u-r.options.scrollOffset&&s&&a<=o){var f=r.collection.last();if(!f)return;r.onFetch(),r.disableFetch(),r.collection.fetch({success:r.fetchSuccess,error:r.fetchError,remove:r.options.remove,data:$.extend(n(f),r.options.extraParams)})}a=o},f(),r}})();