(function(){"use strict";var e=[];Backbone.NestedModel=Backbone.Model.extend({get:function(e){var t=Backbone.NestedModel.attrPath(e),n;return Backbone.NestedModel.walkPath(this.attributes,t,function(e,r){var i=_.last(r);r.length===t.length&&(n=e[i])}),n},has:function(e){var t=this.get(e);return t!==null&&!_.isUndefined(t)},set:function(e,t,n){var r=Backbone.NestedModel.deepClone(this.attributes),i;_.isString(e)?i=Backbone.NestedModel.attrPath(e):_.isArray(e)&&(i=e);if(i)n=n||{},this._setAttr(r,i,t,n);else{n=t||{};var s=e;for(var o in s)s.hasOwnProperty(o)&&this._setAttr(r,Backbone.NestedModel.attrPath(o),n.unset?null:s[o],n)}if(!this._validate(r,n))return this.changed={},!1;if(n.unset&&i&&i.length===1){var u={};u[e]=null,Backbone.NestedModel.__super__.set.call(this,u,n)}else n.unset&&i&&(n=_.extend({},n),delete n.unset),Backbone.NestedModel.__super__.set.call(this,r,n);return this._runDelayedTriggers(),this},clear:function(e){e=e||{};if(!e.silent&&this.validate&&!this.validate({},e))return!1;var t=this.changed={},n=this,r=function(i,s){_.each(i,function(o,u){var a=s;_.isArray(i)?a+="["+u+"]":s?a+="."+u:a=u,o=i[u],_.isObject(o)&&r(o,a),e.silent||n._delayedChange(a,null),t[a]=null})};return r(this.attributes,""),this.attributes={},this._escapedAttributes={},e.silent||this._delayedTrigger("change"),this._runDelayedTriggers(),this},add:function(e,t,n){var r=this.get(e);if(!_.isArray(r))throw new Error("current value is not an array");return this.set(e+"["+r.length+"]",t,n)},remove:function(e,t){t=t||{};var n=Backbone.NestedModel.attrPath(e),r=_.initial(n),i=this.get(r),s=_.last(n);if(!_.isArray(i))throw new Error("remove() must be called on a nested array");var o=!t.silent&&i.length>=s+1,u=i[s];i.splice(s,1),t.silent=!0,this.set(r,i,t);if(o){e=Backbone.NestedModel.createAttrStr(r),this.trigger("remove:"+e,this,u);for(var a=r.length;a>=1;a--)e=Backbone.NestedModel.createAttrStr(_.first(r,a)),this.trigger("change:"+e,this,u);this.trigger("change",this,u)}return this},toJSON:function(){return Backbone.NestedModel.deepClone(this.attributes)},_delayedTrigger:function(){e.push(arguments)},_delayedChange:function(e,t){this._delayedTrigger("change:"+e,this,t),this.changed[e]=t},_runDelayedTriggers:function(){while(e.length>0)this.trigger.apply(this,e.shift())},_setAttr:function(e,t,n,r){r=r||{};var i=t.length,s=this;Backbone.NestedModel.walkPath(e,t,function(e,o){var u=_.last(o),a=Backbone.NestedModel.createAttrStr(o),f=!_.isEqual(e[u],n);if(o.length===i){r.unset?(delete e[u],delete s._escapedAttributes[a]):e[u]=n;if(!r.silent&&_.isObject(n)&&f){var l=function(e,t){var n,r;for(var i in e)e.hasOwnProperty(i)&&(n=t+"."+i,r=e[i],_.isEqual(s.get(n),r)||s._delayedChange(n,r),_.isObject(r)&&l(r,n))};l(n,a)}if(n===null){var c=Backbone.NestedModel.createAttrStr(_.initial(t));s._delayedTrigger("remove:"+c,s,e[u])}}else e[u]||(_.isNumber(u)?e[u]=[]:e[u]={});r.silent||(o.length>1&&f&&s._delayedChange(a,e[u]),_.isArray(e[u])&&s._delayedTrigger("add:"+a,s,e[u]))})}},{attrPath:function(e){var t;return _.isString(e)?(t=e===""?[""]:e.match(/[^\.\[\]]+/g),t=_.map(t,function(e){return e.match(/^\d+$/)?parseInt(e,10):e})):t=e,t},createAttrStr:function(e){var t=e[0];return _.each(_.rest(e),function(e){t+=_.isNumber(e)?"["+e+"]":"."+e}),t},deepClone:function(e){return $.extend(!0,{},e)},walkPath:function(e,t,n,r){var i=e,s;for(var o=0;o<t.length;o++){n.call(r||this,i,t.slice(0,o+1)),s=t[o],i=i[s];if(!i)break}}})})();