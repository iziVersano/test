(function(e){"use strict";var t,n=e.Backbone,r=e._,i=e.$,s=n.View.prototype._configure,o=n.View.prototype.render,u=n.View.extend({constructor:function(e){e=e||{},u.setupView(this,e),n.View.call(this,e)},swapLayout:function(e){return e.views=r.defaults({},this.views,e.views),e.setElement(this.el),e},insertView:function(e,t){return t?this.setView(e,t,!0):this.setView(e,!0)},insertViews:function(e){return r.each(e,function(t,n){e[n]=[].concat(t)}),this.setViews(e)},getView:function(e){return this.getViews(e).first().value()},getViews:function(e){var t=r.chain(this.views).map(function(e){return[].concat(e)},this).flatten().value();return r.chain(r.filter(t,e?e:r.identity))},setView:function(e,t,n){var i,s,o=this;r.isString(e)||(n=t,t=e,e=""),this.views=this.views||{},!n&&this.views[e]&&(r.isArray(this.views[e])?r.each(this.views[e],function(e){e.remove()}):this.views[e].remove());if(!t.__manager__)throw new Error("manage property not set.  http://tbranyen.github.com/backbone.layoutmanager/#usage/structuring-a-view");return s=t._options(),t.__manager__||u.setupView(t,s),t.render=function(i){function a(){(!n||t.keep||!l.hasRendered)&&s.partial(o.el,e,t.el,n),t.delegateEvents(),l.handler&&(l.handler.resolveWith(t,[t.el]),delete l.handler),f.resolveWith(t,[t.el]),r.isFunction(i)&&i.call(t,t.el)}var f=s.deferred(),l=t.__manager__;return l.viewDeferred=f,t._removeViews(),u.prototype.render.call(t).then(a),f.promise()},t.__manager__.parent=o,t.__manager__.selector=e,n?(i=this.views[e]=this.views[e]||[],r.isArray(this.views[e])||(i=this.views[e]=[this.views[e]]),r.indexOf(i,t)>-1?t:(i.push(t),t.__manager__.append=!0,t)):this.views[e]=t},setViews:function(e){return r.each(e,function(e,t){if(r.isArray(e))return r.each(e,function(e){this.insertView(t,e)},this);this.setView(t,e)},this),this},render:function(e){var t=this,n=this._options(),i=n.deferred(),s=this.__manager__;return s.renderDeferred?(s.callback=e,s.renderDeferred):(s.renderDeferred=i,this._render(u._viewRender).fetch.then(function(){var e=r.map(t.views,function(e){function t(e,n){if(!e.length)return n();var r=e.shift();r.render(function(){t(e,n)})}var i;return r.isArray(e)?(i=n.deferred(),t(r.clone(e),function(){i.resolve()}),i.promise()):e.render()});n.when(e).then(function(){i.resolveWith(t,[t.el])})}),i.then(function(){r.isFunction(e)&&e.call(t,t.el),t.__manager__.handler&&(t.__manager__.handler.resolveWith(t,[t.el]),delete t.__manager__.handler),r.isFunction(t.__manager__.callback)&&(t.__manager__.callback.call(t,t.el),delete t.__manager__.callback),delete t.__manager__.renderDeferred}))},remove:function(){return u.cleanViews(this),u._removeView(this,!0),this._remove.apply(this,arguments)},_options:function(){return r.extend({},this,u.prototype.options,this.options)}},{_cache:{},_makeAsync:function(e,t){var n=e.deferred();return n.async=function(){return n._isAsync=!0,t},n},_viewRender:function(e){function t(t,r){u.cache(n,r),r&&o.html(e.el,o.render(r,t)),s.fetch.resolveWith(e,[e.el])}var n,i,s,o=e._options();return{render:function(a){var f=e.__manager__,l=e.template||o.template;return e.serialize&&(o.serialize=e.serialize),!a&&r.isFunction(o.serialize)?a=o.serialize.call(e):!a&&r.isObject(o.serialize)&&(a=o.serialize),s=u._makeAsync(o,r.bind(t,e,a)),s.fetch=o.deferred(),f.handler=s,r.isString(l)&&(n=f.prefix+l),(i=u.cache(n))?(t(a,i,n),s):(r.isString(l)?i=o.fetch.call(s,f.prefix+l):l!=null&&(i=o.fetch.call(s,l)),s._isAsync||t(a,i),s)}}},cleanViews:function(e){r.each([].concat(e),function(e){e.unbind(),e.views&&r.each(e.views,function(e){u.cleanViews(e)}),r.isFunction(e.cleanup)&&e.cleanup.call(e)})},cache:function(e,t){if(e in this._cache)return this._cache[e];if(e!=null&&t!=null)return this._cache[e]=t},configure:function(e){r.extend(u.prototype.options,e),e.manage&&(n.View.prototype.manage=!0)},setupView:function(e,i){var s,o,a=n.LayoutManager.prototype,f=r.pick(e,t);if(e.__manager__)return;r.defaults(e,{views:{},__manager__:{},_options:u.prototype._options,_removeViews:u._removeViews,_removeView:u._removeView}),e instanceof n.Layout?e.__manager__.prefix=e._options().paths.layout||"":e.__manager__.prefix=e._options().paths.template||"",i=e.options=r.defaults(i||{},e.options,a.options),o=r.pick(i,["events"].concat(r.values(i.events))),r.extend(e,o),delete f.render,r.extend(i,f),e._remove=n.View.prototype.remove,e._render=function(e){var t,n=this._options().beforeRender,s=this._options().afterRender;return this._removeViews(),r.isFunction(n)&&n.call(this,this),this.trigger("beforeRender",this),t=e(this).render(),t.then(function(){var e=this,t=e.__manager__,n=t.parent,o=function(){e.delegateEvents(),e.__manager__.hasRendered=!0,r.isFunction(s)&&s.call(e,e),e.trigger("afterRender",e)},u=function(e){var t=e.__manager__;return t.parent&&!t.parent.__manager__.hasRendered?t.parent:e};if(!n)return o.call(e);if(n.__manager__.hasRendered)return i.when([t.viewDeferred,n.__manager__.viewDeferred]).then(function(){o.call(e)});n=u(e),n.on("afterRender",function(){n.off(null,null,e),o.call(e)},e)}),t},e.render=u.prototype.render,e.remove!==a.remove&&(e._remove=e.remove,e.remove=a.remove),s=i.views||e.views,r.keys(s).length&&e.setViews(s),e.template&&(i.template=e.template,delete e.template)},_removeViews:function(e){e=e||this,e.getViews().each(function(e){u._removeView(e,!0)})},_removeView:function(e,t){var n=e.__manager__,i=r.isBoolean(e.keep)?e.keep:e.options.keep;t=t&&n.parent;if(!i&&(n.append===!0||t)&&n.hasRendered){e.$el.remove();if(r.isArray(n.parent.views[n.selector]))return n.parent.getView(function(e,t){e.__manager__.selector===n.selector&&n.parent.views[n.selector].splice(t,1)});delete n.parent.views[n.selector]}}});r.each(["get","set","insert"],function(e){var t=n.View.prototype,r=u.prototype;t[e+"View"]=r[e+"View"],t[e+"Views"]=r[e+"Views"]}),n.Layout=n.LayoutManager=u,n.LayoutView=n.View.extend({manage:!0}),n.View.prototype._configure=function(){var e=s.apply(this,arguments);return this.manage&&u.setupView(this),e},u.prototype.options={paths:{},deferred:function(){return i.Deferred()},fetch:function(e){return r.template(i(e).html())},partial:function(e,t,n,r){var s=t?i(e).find(t):i(e);return s.length?(this[r?"append":"html"](s,n),!0):!1},html:function(e,t){i(e).html(t)},append:function(e,t){i(e).append(t)},when:function(e){return i.when.apply(null,e)},render:function(e,t){return e(t)}},t=r.keys(u.prototype.options)})(this);